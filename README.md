# partner-document

Generated by `ts-nozzy`!

## Components

### Transports
| **Option** | **Enabled** |
|---|---|
| gRPC server | ![enabled](https://img.icons8.com/color/24/000000/checked.png) |
| gRPC client | ![disabled](https://img.icons8.com/color/24/000000/close-window.png) |
| HTTP server | ![disabled](https://img.icons8.com/color/24/000000/close-window.png) |
| AMQP consume | ![disabled](https://img.icons8.com/color/24/000000/close-window.png) |
| AMQP publish | ![disabled](https://img.icons8.com/color/24/000000/close-window.png) |





### Database
| **Option** | **Enabled** |
|---|---|
| MySQL | ![enabled](https://img.icons8.com/color/24/000000/checked.png) |
| MongoDB | ![disabled](https://img.icons8.com/color/24/000000/close-window.png) |

## Structure
For each listening transport (gRPC, HTTP and AMQP (Consume)) there is an file called `<transport>-app.js` in the root
of the `src` folder. These are the entry points of the corresponding apps. All can be used together.

### gRPC
You need to generate the stubs from `generate_ts.sh` in the
[protobuf](https://bitbucket.org/jdbergmann/protobuf/src/master/) repo. You always generate the stubs for a whole stack.
E.g. you generate the stubs for the object stack like this

```
./generate_ts.sh object/
```

The generated stubs are written to the folder `gen_ts`. Copy the needed stubs into your microservice at
`src/proto/generated`. Be sure to retain the generated folder structure. In case of the object stack and insurance
service this would look like `src/proto/generated/object/insurance/`.

### AMQP
#### proto.js
The file `src/proto/proto.js` is used for encoding and decoding AMQP mesages. You can generate this file by running

```
pbjs -t static-module -w es6 -o proto.js product/authorization/authorization.proto
```

inside the protobuf repo root folder. You can add as many proto files as you like!

### HTTP
Use the generated Swagger module to validate requests and responses. E.g. look at the
[product-api](https://bitbucket.org/jdbergmann/product/src/develop/api/src/routes/web.js) POST /authorization route on
how to use it!

The route `/api-docs/web` exposes the Swagger UI while `api-docs/json` exposes the JSON specification.

### MySQL
#### Migrations
Generate a new one with `typeorm migration:create -n <migration_name>`
```
import {MigrationInterface, QueryRunner, TableColumn, TableIndex} from 'typeorm';

export class RemoveBuildingId1572952702055 implements MigrationInterface {

    public async up(queryRunner: QueryRunner): Promise<void> {
        await queryRunner.dropIndex('insurances', 'IDX_building_id');
        await queryRunner.dropColumn('insurances', 'building_id');
    }

    public async down(queryRunner: QueryRunner): Promise<void> {
        await queryRunner.addColumn('insurances', new TableColumn({
            name: 'building_id',
            type: 'string',
            length: '50'
        }));
        await queryRunner.createIndex('insurances', new TableIndex({
            name: 'IDX_building_id',
            columnNames: ['building_id']
        }));
    }

}
```

## docker-compose
You can use the following template to add it to the repo's root docker-compose.yml.

```
### partner-document #####################################
  partner-document:
    build:
      context: ./partner-document
      dockerfile: Dockerfile
    ports:
      - "50051:50051"
    environment:
      - TZ=Europe/Zurich
      - GRPC_PORT=50051
      - HTTP_PORT=3000
      - NODE_ENV=development
      - LOG_LEVEL=debug
```
